Получение лидов из форм FB
===

## Создание DEMO-приложения

Требования:
- Должно иметь адрес для получения веб-хуков и обработки подписки

## Обработка запроса подписки

Чтобы приложения получало от FB события с помощью веб-хуков, необходимо подписать определенный адрес на те или иные события. Это можно сделать через GraphAPI или через интерфейс FB. В обих случаях на адрес хука приходит запрос подписки, который необходимо обрабатывать.

Запрос подписки это GET-запрос со следующими параметрами:
- `hub.mode`: Тип запроса, должен быть `subscribe`, который соответствует подписке
- `hub.verify_token`: Токен верификации приложения, задается во время запроса подписки, любая строка, которую вы сохраните в настройках на сервере, и добавите в запрос подписки
- `hub.challenge`: код, который нужно отправить назад, в случае, если подписка прошла успешно

Необходимо убедиться что режим задан как `subscribe`, токен верификации соответствует тому, который вы передали в запросе, и в случае успеха вернуть код из `hub.challenge`.

Пример реализации в `graph-api.js` в методе `checkSubscription`.

## Подписка на веб-хуки страницы через GraphAPI

Для подписки приложения на событие через API, нужно выполнить запрос на ручку `/${client_id}/subscriptions`, где `client_id` — ID приложения с параметрами:
- `callback_url`: адрес обработки веб-хуков
- `object`: объект, события которого нужны, в нашем случае это `page`
- `fields`: события обеъекта через запятую, в нашем случае это `leadgen`
- `verify_token`: токен верификации приложения, который будет проверяться вами при обработки запроса подписки
- `access_token`: токен доступа приложения, можно получить в настроках приложения

## Обработка событий

События присылаются POST-запросом на адрес для веб-хуков, на который была настроена подписка на предыдущем шаге. Данные передаются в формате JSON.

Структура данных запроса:
- `object`: тип объекта события которого было прислано, в нашем случае должно быть `page`
- `entry`: массив событий

Структура события:
- `changes`: массив изменений,  
- `id`: идентификатор объекта (нужно обедиться что это события от той страницы, на которую мы подписаны),
- `uid`: хз,
- `time`: время чего-то там,

Структура изменений:
- `field`: поле, в нашем случае это `leadgen`,
- `value`: информация об изменении, в нашем случае информация о лиде

Информация о лиде:
- `leadgen_id`: идентификатор лида
- `form_id`: идентификатор форма
- `page_id`: идентификатор страницы
- `created_time`: время создания

По `leadgen_id` и по `form_id` в GraphAPI можно вытащить информацию о лиде, и информацию о форме.

Ручка для формы `/${form_id}`, структура ответа:
- `id`: ID формы
- `name`: название формы, тут можно вытащить параметры продукта и код партнера, по аналогии с ВК

Ручка для лида `/${leadgen_id}`, структура ответа:
- `created_time`: время создания
- `id`: идентификатор лида
- `field_data`: поля формы массив

Поле формы:
- `name`: имя поля (`first_name`, `phone_number`, `email`)
- `values`: массив значений


## Пройти подтверждение приложения

Без подтверждения приложения даже тестовые лиды не отправляются в приложение.

Для прохождения подтверждения приложения необходимо:
- пройти проверку приложения (сделав вид, что оно работает);
- подключить его существующему бизнес-менеджеру FB, или создать новый;
- предоставить документы подтверждающие название юридического и адрес;
- подписать соглашение с FB.

## Получение токена администратора страницы

Запрашивать токен администратора лучше в админке сайта в настройках FB-интеграции.

Токен необходим, чтобы приложение могло действовать от имени пользователя. Необходим токен, который будет жить долго. Поэтому виджет FB для авторизации лучше не использовать, так как он дает короткие токены.

Адрес страницы шлюза должен быть добавлен в настройках авторизации приложения на FB.

Флоу авторизации сервера:
1. Переходим на страницу `/signin`
2. Формируем адрес страницы авторизации с правами `leads_retrieval` и `manage_pages` и адресом страницы шлюза
3. Перенаправляем на полученную страницу
4. Ждем пользователя на странице шлюза `/oauth`
5. Если авторизация не удалась, мы получим GET-параметры `error*` описывыющие ошибку
6. Если авторизация успешная, при типе запроса `response_type=code` мы получим код
7. Обмениваем код на токен
8. Сохраняем токен пользователя, приложение авторизовано

О чем следует подумать:
- У токена пользователя есть срок жизни, и его периодически необходимо обновлять
- Пользователь может разавторизовать приложение на стороне FB, для обработки этой ситуации нужно настроить колбек в настройках приложения на FB (`/unlink`).

Проверить права пользователя доступные приложению можно выполнив запрос к Graph API на ручку `/me/permissions`.

## Получение токена страницы

Лид-формы привязаны к страницам. Поэтому для получения данных лидов необходимо подписаться на события страницы. Для этого приложение должно получить право выполнять запросы от имени страницы. Это возможно при наличия токена страницы.

Для получения токенов доступа к страницам, необходимо выполнить запрос к ручке GraphAPI `/${userId}/accounts`. Тут `userID` — идентификатор администратора страницы, токен доступа которого мы получили на предыдущем шаге. Чтобы получить его ID можно сделать запрос к ручке `/me`.

Флоу получения токена страницы:
1. Авторизуем пользователя (сделано на прошлом шаге)
2. Получаем его ID
3. Получаем список всех его страниц
4. Показываем ему список и предлагаем выбрать ту, которую привязать к приложения
5. Получаем и сохраняем токен и прочую информацию о полученной странице (привязываем к приложению)



## Технические подробности

### Адрес страницы авторизации

Маска адреса: `https://www.facebook.com/${version}/dialog/oauth${query}`

Тут:
- `version`: версия API, на момент написания это `v3.2`
- `query`: набор GET-параметров

Get-параметры:
- `client_id`: *обязательный*, ID приложения, в настройках приложения на FB.
- `redirect_uri`: *обязательный*, абсолютный адрес шлюза на сайте для обратного вызова, должен быть указан в настройках приложения на FB.
- `scope`: права приложения, по умолчанию даются минимальные права на получение базовой информации (имя, почта)
- `state`: любые данные которые потом вернутся в запросе к шлюзу
- `response_type`: тип запроса, возможные значение `code`, `token`, `code%20token`, `granted_scopes`, по умолчанию `code`,
- `auth_type`: для повторного запроса отклоненных разрешений, значение `rerequest`

Пример формирования адреса в файле `graph-api.js` в методе `getAuthDialogUrl`

### Колбек авторизации на страницу шлюза

При `response_type=code`, в случае успеха получаем следующие GET-параметры:
- `code`: код авторизации, которые необходимо обменять на токен
- `state`: любые данные которые были переданы в `state` при перенаправлении на страницу авторизации

В случае ошибки:
- `error`: тип ошибки
- `error_reason`: причина ошибки
- `error_description`: Описание ошибки

### Выполнение запросов к GraphAPI

Запросы отправляются по HTTP методом GET или POST.

Маска: `https://graph.facebook.com/${version}${endpoint}${query}`

Тут:
- `version`: версия API, на момент написания это `v3.2`
- `endpoint`: ручка, например `/me`
- `query`: GET-параметры запроса, на случай GET-запроса. У каждой ручки свои параметры. Параметров может и не быть.

Единственный практически всегда используемый параметр это `access_token`, они могут быть 3 типов:
- токен приложения, только для ручек настройки самого приложения
- токен пользователя, для выполнения действий от имени пользователя
- токен страницы, для выполнения действий от имени страницы

Ответ приходит в JSON-формате. В случае ошибки есть свойство `error`, это _объект_ с описанием типа и причины ошибки

Пример реализации в `graph-api.js` в методе `api`
